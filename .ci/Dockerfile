FROM node:17-bullseye-slim

# AWS args
ARG AWS_SECRET_ACCESS_KEY
ARG AWS_ACCESS_KEY_ID
ARG GUIDANCE_AWS_BUCKET_NAME

ARG CONNECTIONSTRINGS__DEFAULTCONNECTION
ARG GITHUBSHA
ARG NODE_ENV=production
ARG NESTJS_PORT
ARG DATABASE_HOST
ARG DATABASE_PORT
ARG DATABASE_USER
ARG DATABASE_PASSWORD
ARG DATABASE_NAME
ARG JWT_SECRET
ARG MODE
ARG RUN_MIGRATIONS
ARG LOKI
ARG LIMESURVEY_API
ARG LIMESURVEY_USER
ARG LIMESURVEY_PASSWORD

# Mailchimp args
ARG MAILCHIMP_PREFIX
ARG MAILCHIMP_API_KEY
ARG MAILCHIMP_AUDIENCE_ID

ARG STATIC_FOLDERS_PATH

# Twilio args
ARG TWILIO_API_SECRET
ARG TWILIO_API_KEY
ARG TWILIO_ACCOUNT_SID
ARG TWILIO_STATUS_CALLBACK_URL
ARG TWILIO_STATUS_CALLBACK_METHOD

# Calendar args
ARG GOOGLE_CLIENT_EMAIL
ARG GOOGLE_PRIVATE_KEY
ARG GOOGLE_CALENDAR_ID
ARG GOOGLE_CALENDAR_WATCHER_TOKEN

# Calendly args
ARG CALENDLY_URL

ARG GOOGLE_FIREBASE_SERVICE_CREADENTIALS
ARG GOOGLE_FIREBASE_DATABASE_URL
ARG GOOGLE_FIREBASE_CONFIG

ENV AWS_SECRET_ACCESS_KEY $AWS_SECRET_ACCESS_KEY
ENV AWS_ACCESS_KEY_ID $AWS_ACCESS_KEY_ID
ENV GUIDANCE_AWS_BUCKET_NAME $GUIDANCE_AWS_BUCKET_NAME

ENV ConnectionStrings__DefaultConnection $CONNECTIONSTRINGS__DEFAULTCONNECTION
ENV Mihmo__Version $GITHUBSHA
ENV NODE_ENV=${NODE_ENV}
ENV NESTJS_PORT $NESTJS_PORT
ENV JWT_SECRET $JWT_SECRET
ENV MODE $MODE
ENV LOKI $LOKI

ENV LIMESURVEY_API $LIMESURVEY_API
ENV LIMESURVEY_USER $LIMESURVEY_USER
ENV LIMESURVEY_PASSWORD $LIMESURVEY_PASSWORD
# Mailchimp API variables
ENV MAILCHIMP_PREFIX $MAILCHIMP_PREFIX
ENV MAILCHIMP_API_KEY $MAILCHIMP_API_KEY
ENV MAILCHIMP_AUDIENCE_ID $MAILCHIMP_AUDIENCE_ID

# Database credentials
ENV DATABASE_HOST $DATABASE_HOST
ENV DATABASE_PORT $DATABASE_PORT
ENV DATABASE_USER $DATABASE_USER
ENV DATABASE_PASSWORD $DATABASE_PASSWORD
ENV DATABASE_NAME $DATABASE_NAME
ENV RUN_MIGRATIONS $RUN_MIGRATIONS

ENV STATIC_FOLDERS_PATH $STATIC_FOLDERS_PATH

# Twilio variables
ENV TWILIO_API_SECRET $TWILIO_API_SECRET
ENV TWILIO_API_KEY $TWILIO_API_KEY
ENV TWILIO_ACCOUNT_SID $TWILIO_ACCOUNT_SID
ENV TWILIO_STATUS_CALLBACK_URL $TWILIO_STATUS_CALLBACK_URL
ENV TWILIO_STATUS_CALLBACK_METHOD $TWILIO_STATUS_CALLBACK_METHOD

ENV GOOGLE_CLIENT_EMAIL $GOOGLE_CLIENT_EMAIL
ENV GOOGLE_PRIVATE_KEY $GOOGLE_PRIVATE_KEY
ENV GOOGLE_CALENDAR_ID $GOOGLE_CALENDAR_ID
ENV GOOGLE_CALENDAR_WATCHER_TOKEN $GOOGLE_CALENDAR_WATCHER_TOKEN

# Calendly variables
ENV CALENDLY_URL $CALENDLY_URL

ENV GOOGLE_FIREBASE_SERVICE_CREADENTIALS $GOOGLE_FIREBASE_SERVICE_CREADENTIALS
ENV GOOGLE_FIREBASE_DATABASE_URL $GOOGLE_FIREBASE_DATABASE_URL
ENV GOOGLE_FIREBASE_CONFIG $GOOGLE_FIREBASE_CONFIG

# ENV TZ="America/Sao_Paulo"

COPY ./dist ./dist
COPY ./views ./views
COPY ./public ./public

WORKDIR /dist
COPY package*.json ./

RUN npm install

EXPOSE ${NESTJS_PORT}
CMD ["node", "main"]
